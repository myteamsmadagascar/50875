<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>CRM ‚Äì Base 6</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body{font-family:Arial;margin:0;background:#f4f6fb}
  header{background:#fff;padding:12px;border-bottom:1px solid #ddd}
  .wrap{max-width:1600px;margin:auto;padding:12px}
  .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;margin-bottom:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button,input,select,textarea{padding:8px;font-size:14px}
  button{border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
  .primary{background:#0b57d0;color:#fff;border-color:#0b57d0;font-weight:bold}
  .danger{background:#ef4444;color:#fff;border-color:#ef4444;font-weight:bold}

  /* IMPORTANT: scroll horizontal + vertical */
  .tableWrap{max-height:60vh;overflow:auto;border:1px solid #ddd;border-radius:12px;background:#fff}
  table{width:100%;border-collapse:collapse;font-size:13px;min-width:1200px}
  th,td{border:1px solid #e5e7eb;padding:6px;vertical-align:top}
  th{background:#eef3ff;position:sticky;top:0;z-index:2}

  .hidden{display:none}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}
  .map{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px}
  .preview{background:#fafafa;border:1px solid #ddd;border-radius:8px;padding:8px;font-size:12px;white-space:pre-wrap;max-height:140px;overflow:auto}
  .small{font-size:12px;color:#555}

  /* ‚úÖ ACTIONS TOUJOURS VISIBLES */
  th.actions, td.actions{
    position:sticky;
    right:0;
    z-index:3;
    background:#fff;
    min-width:160px;
  }
  th.actions{background:#eef3ff}
  .btnMini{padding:7px 10px;border-radius:8px;border:1px solid #cbd5e1;background:#fff}
  .btnMini.primary{background:#0b57d0;color:#fff;border-color:#0b57d0}
  .btnMini.danger{background:#ef4444;color:#fff;border-color:#ef4444}

  /* ‚úÖ MOBILE: on masque quelques colonnes pour √©viter ‚Äútrop large‚Äù */
  @media(max-width:720px){
    .hideMobile{display:none}
    table{min-width:900px}
    th.actions, td.actions{min-width:150px}
  }
</style>
</head>

<body>

<header class="row" style="justify-content:space-between;flex-wrap:wrap">
  <b>CRM ‚Äì appel manuel (BASE 6)</b>

  <div class="row" style="flex-wrap:wrap">
    <button onclick="location.href='index.html'">üè† Index</button>
    <button onclick="location.href='base.html'">Base</button>
    <button onclick="location.href='base1.html'">Base 1</button>
    <button onclick="location.href='base2.html'">Base 2</button>
    <button onclick="location.href='base3.html'">Base 3</button>
    <button onclick="location.href='base4.html'">Base 4</button>
    <button onclick="location.href='base5.html'">Base 5</button>
    <button onclick="location.href='base6.html'">Base 6</button>
    <button onclick="location.href='reporting.html'">üìä Reporting</button>
  </div>
</header>

<div class="wrap">

  <div class="card row">
    <button class="primary" onclick="openForm()">Ajouter</button>
    <button onclick="openImport()">Importer</button>
    <button onclick="exportCSV()">Exporter CSV</button>
    <button class="danger" onclick="deleteAll()">Tout supprimer</button>

    <select id="rangeSelect" onchange="applyRange()">
      <option value="0">1‚Äì100</option><option value="100">101‚Äì200</option>
      <option value="200">201‚Äì300</option><option value="300">301‚Äì400</option>
      <option value="400">401‚Äì500</option><option value="500">501‚Äì600</option>
      <option value="600">601‚Äì700</option><option value="700">701‚Äì800</option>
      <option value="800">801‚Äì900</option><option value="900">901‚Äì1000</option>
    </select>

    <span class="small">Total : <b id="total">0</b></span>
    <span class="small" id="rangeLabel">Affichage : 1‚Äì100</span>
  </div>

  <div class="card tableWrap">
    <table>
      <thead>
        <tr>
          <th>Nom</th>
          <th>Pr√©nom</th>
          <th class="hideMobile">Adresse</th>
          <th class="hideMobile">Ville</th>
          <th class="hideMobile">CP</th>
          <th class="hideMobile">Fixe</th>
          <th>Mobile</th>
          <th>RDV</th>
          <th>Rappel</th>
          <th>Statut</th>
          <th>Rep1</th>
          <th class="hideMobile">Rep2</th>
          <th>Commentaire</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="14" class="small">Chargement‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>

  <!-- FORM -->
  <div id="formCard" class="card hidden">
    <b>Ajouter / Modifier</b>
    <div class="grid">
      <input id="f_nom" placeholder="Nom">
      <input id="f_prenom" placeholder="Pr√©nom">
      <input id="f_adresse" placeholder="Adresse">
      <input id="f_ville" placeholder="Ville">
      <input id="f_cp" placeholder="CP">
      <input id="f_fixe" placeholder="Fixe">
      <input id="f_mobile" placeholder="Mobile">
      <input id="f_rdv" type="date">
      <input id="f_rappel" type="date">
      <select id="f_statut">
        <option>√Ä appeler</option><option>RDV</option>
        <option>√Ä rappeler</option><option>Refus</option>
        <option>Hors cible</option>
      </select>
      <input id="f_rep1" placeholder="R√©ponse 1">
      <input id="f_rep2" placeholder="R√©ponse 2">
    </div>
    <textarea id="f_commentaire" placeholder="Commentaire"></textarea>
    <div class="row">
      <button class="primary" onclick="save()">Enregistrer</button>
      <button onclick="closeForm()">Annuler</button>
    </div>
  </div>

  <!-- IMPORT -->
  <div id="importCard" class="card hidden">
    <b>Import (CSV / TXT / XLS) ‚Äì Mapping manuel</b>

    <div class="row">
      <select id="fmt">
        <option value="csv">CSV</option>
        <option value="txt">TXT</option>
        <option value="xls">XLS / XLSX</option>
      </select>

      <label class="small">Limite</label>
      <input id="limitImport" type="number" value="500" style="width:90px">

      <input type="file" id="file">
      <button onclick="loadFile()">Charger</button>
    </div>

    <div class="map" id="mappingBox"></div>

    <div class="row">
      <button class="primary" onclick="validateImport()">Valider import</button>
      <button onclick="closeImport()">Fermer</button>
      <span class="small" id="importInfo"></span>
    </div>

    <div class="preview" id="preview">Aper√ßu‚Ä¶</div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc,
onSnapshot, serverTimestamp, getDocs, query, limit }
from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

/* üî• BASE 6 */
const app = initializeApp({
  apiKey:"AIzaSyA-G8P5NokxI6ZaIOMroQrH4x8mp_Q2dgg",
  authDomain:"axokit-crm-ecoles-e56ab.firebaseapp.com",
  projectId:"axokit-crm-ecoles-e56ab"
});
const db = getFirestore(app);
const COLLECTION="crm_base6";
const colRef=collection(db,COLLECTION);

const $=id=>document.getElementById(id);
const clean=v=>(v??"").toString().trim();

let ALL=[],START=0,LIMITN=100,EDIT_ID=null;

/* LIVE */
onSnapshot(colRef,s=>{
  ALL=s.docs.map(d=>({id:d.id,...d.data()}));
  $("total").textContent=ALL.length;
  render();
});

function render(){
  const slice=ALL.slice(START,START+LIMITN);
  const tb=$("tbody");
  if(!slice.length){
    tb.innerHTML=`<tr><td colspan="14" class="small">Vide</td></tr>`;
    return;
  }
  tb.innerHTML=slice.map(x=>`
<tr>
  <td>${x.nom||""}</td>
  <td>${x.prenom||""}</td>
  <td class="hideMobile">${x.adresse||""}</td>
  <td class="hideMobile">${x.ville||""}</td>
  <td class="hideMobile">${x.cp||""}</td>
  <td class="hideMobile">${x.fixe||""}</td>
  <td>${x.mobile||""}</td>
  <td>${x.rdv||""}</td>
  <td>${x.rappel||""}</td>
  <td>${x.statut||""}</td>
  <td>${x.rep1||""}</td>
  <td class="hideMobile">${x.rep2||""}</td>
  <td>${x.commentaire||""}</td>
  <td class="actions">
    <button class="btnMini primary" onclick="editRow('${x.id}')">Modifier</button>
    <button class="btnMini danger" onclick="delRow('${x.id}')">Supprimer</button>
  </td>
</tr>`).join("");
}

window.applyRange=()=>{
  START=parseInt(rangeSelect.value);
  $("rangeLabel").textContent = `Affichage : ${START+1}‚Äì${START+100}`;
  render();
};

/* CRUD */
window.openForm=()=>{EDIT_ID=null;formCard.classList.remove("hidden");};
window.closeForm=()=>formCard.classList.add("hidden");

window.editRow=id=>{
  const x=ALL.find(a=>a.id===id);
  if(!x) return;
  EDIT_ID=id;
  ["nom","prenom","adresse","ville","cp","fixe","mobile","rdv","rappel","rep1","rep2","commentaire"]
    .forEach(k=>$("f_"+k).value=x[k]||"");
  f_statut.value=x.statut||"√Ä appeler";
  openForm();
};

window.save=async()=>{
  const o={
    nom:clean(f_nom.value),prenom:clean(f_prenom.value),
    adresse:clean(f_adresse.value),ville:clean(f_ville.value),
    cp:clean(f_cp.value),fixe:clean(f_fixe.value),
    mobile:clean(f_mobile.value),rdv:clean(f_rdv.value),
    rappel:clean(f_rappel.value),statut:f_statut.value,
    rep1:clean(f_rep1.value),rep2:clean(f_rep2.value),
    commentaire:clean(f_commentaire.value),
    updatedAt:serverTimestamp()
  };
  EDIT_ID
    ?await updateDoc(doc(db,COLLECTION,EDIT_ID),o)
    :await addDoc(colRef,{...o,createdAt:serverTimestamp()});
  closeForm();
};

window.delRow=async id=>{
  if(confirm("Supprimer ?")) await deleteDoc(doc(db,COLLECTION,id));
};

window.deleteAll=async()=>{
  if(prompt("Mot de passe")!=="admin2026") return;
  if(!confirm("SUPPRIMER TOUTE LA BASE 6 ?")) return;
  while(true){
    const s=await getDocs(query(colRef,limit(500)));
    if(s.empty) break;
    for(const d of s.docs) await deleteDoc(doc(db,COLLECTION,d.id));
  }
};

/* EXPORT */
window.exportCSV=()=>{
  let csv="nom;prenom;adresse;ville;cp;fixe;mobile;rdv;rappel;statut;rep1;rep2;commentaire\n";
  ALL.forEach(x=>{
    csv+=`${x.nom||""};${x.prenom||""};${x.adresse||""};${x.ville||""};${x.cp||""};${x.fixe||""};${x.mobile||""};${x.rdv||""};${x.rappel||""};${x.statut||""};${x.rep1||""};${x.rep2||""};${x.commentaire||""}\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="base6.csv";
  a.click();
};

/* IMPORT */
let importHeaders=[], importRows=[];

window.openImport=()=>importCard.classList.remove("hidden");
window.closeImport=()=>importCard.classList.add("hidden");

window.loadFile=async()=>{
  const f=file.files[0];
  if(!f) return alert("Choisir un fichier");
  importHeaders=[]; importRows=[];
  mappingBox.innerHTML=""; preview.textContent="";
  const format=fmt.value;

  if(format==="xls"){
    const buf=await f.arrayBuffer();
    const wb=XLSX.read(buf,{type:"array"});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const arr=XLSX.utils.sheet_to_json(ws,{header:1,defval:""});
    importHeaders=arr[0]||[];
    importRows=(arr.slice(1)||[]);
  }else{
    const txt=await f.text();
    const lines=txt.replace(/\r/g,"").split("\n").filter(l=>l.trim());
    importHeaders=(lines[0]||"").split(/[,;|\t]/);
    importRows=lines.slice(1).map(l=>l.split(/[,;|\t]/));
  }

  const fields=["nom","prenom","adresse","ville","cp","fixe","mobile","rdv","rappel","statut","rep1","rep2","commentaire"];
  mappingBox.innerHTML=fields.map(ff=>`
<select data-field="${ff}">
  <option value="">-- ${ff} --</option>
  ${importHeaders.map((h,i)=>`<option value="${i}">${h}</option>`).join("")}
</select>`).join("");

  preview.textContent=importRows.slice(0,5).map(r=>r.join(" | ")).join("\n");
  importInfo.textContent=`${importRows.length} lignes d√©tect√©es`;
};

window.validateImport=async()=>{
  const map=[...mappingBox.querySelectorAll("select")]
    .reduce((a,s)=>{if(s.value!=="") a[s.dataset.field]=parseInt(s.value,10);return a;},{});
  if(!Object.keys(map).length) return alert("Mapping requis");

  const max=Math.max(1, parseInt(limitImport.value||"500",10));
  const rows=importRows.slice(0,max);

  let n=0;
  for(const r of rows){
    const o={createdAt:serverTimestamp()};
    for(const k in map) o[k]=(r[map[k]]||"").toString().trim();
    if(!o.statut) o.statut="√Ä appeler";
    await addDoc(colRef,o);
    n++;
  }
  importInfo.textContent=`Import termin√© : ${n}`;
};
</script>

</body>
</html>