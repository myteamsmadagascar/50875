<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>CRM – Base 2</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f6fb}
header{background:#fff;border-bottom:1px solid #d9dee7;padding:12px}
.wrap{max-width:1600px;margin:auto;padding:12px}
.card{background:#fff;border:1px solid #d9dee7;border-radius:12px;padding:12px;margin-bottom:12px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button,input,select,textarea{padding:9px;font-size:14px}
button{border-radius:10px;border:1px solid #d9dee7;background:#fff;cursor:pointer}
.primary{background:#0b57d0;color:#fff;border-color:#0b57d0;font-weight:700}
.danger{background:#ef4444;color:#fff;border-color:#ef4444;font-weight:700}
.tableWrap{max-height:60vh;overflow:auto;border:1px solid #d9dee7;border-radius:12px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #e6eaf0;padding:6px;font-size:13px}
th{background:#eef3ff;position:sticky;top:0}
.hidden{display:none}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}
.map{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px}
.preview{max-height:140px;overflow:auto;border:1px solid #d9dee7;border-radius:12px;padding:8px;background:#fafafa;font-size:12px;white-space:pre-wrap}
.pill{border:1px solid #d9dee7;border-radius:999px;padding:6px 10px;font-size:12px;background:#f8fafc}
.small{font-size:12px;color:#556}
</style>
</head>

<body>

<header>
  <div class="row" style="justify-content:space-between">
    <div class="row">
      <b>CRM – BASE 2</b>
      <span class="pill">Collection : <b>crm_base2</b></span>
      <span class="pill">Total : <b id="total">0</b></span>
      <span class="pill" id="rangeLabel">1  100</span>
      <span class="pill small" id="fb">Firebase…</span>
    </div>
    <div class="row">
      <button onclick="location.href='index.html'">Index</button>
      <button onclick="location.href='reporting.html'">Reporting</button>
      <button onclick="location.href='base1.html'">Base 1</button>
      <button onclick="location.href='base3.html'">Base 3</button>
    </div>
  </div>
</header>

<div class="wrap">

<div class="card row">
  <button class="primary" onclick="openForm()">Ajouter</button>
  <button onclick="openImport()">Importer</button>
  <button onclick="exportCSV()">Exporter CSV</button>
  <button class="danger" onclick="deleteAll()">Tout supprimer</button>

  <select id="rangeSelect" onchange="applyRange()">
    <option value="0">1  100</option>
    <option value="100">101  200</option>
    <option value="200">201  300</option>
    <option value="300">301  400</option>
    <option value="400">401  500</option>
    <option value="500">501  600</option>
    <option value="600">601  700</option>
    <option value="700">701  800</option>
    <option value="800">801  900</option>
    <option value="900">901  1000</option>
  </select>
</div>

<div class="card tableWrap">
<table>
<thead>
<tr>
<th>Nom</th><th>Prénom</th><th>Adresse</th><th>Ville</th><th>CP</th>
<th>Fixe</th><th>Mobile</th><th>RDV</th><th>Rappel</th>
<th>Statut</th><th>Rep1</th><th>Rep2</th><th>Commentaire</th><th>Actions</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- FORM -->
<div id="formCard" class="card hidden">
<b id="formTitle">Ajouter</b>
<div class="grid">
<input id="f_nom" placeholder="Nom">
<input id="f_prenom" placeholder="Prénom">
<input id="f_adresse" placeholder="Adresse">
<input id="f_ville" placeholder="Ville">
<input id="f_cp" placeholder="Code postal">
<input id="f_fixe" placeholder="Fixe">
<input id="f_mobile" placeholder="Mobile">
<input id="f_rdv" type="date">
<input id="f_rappel" type="date">
<select id="f_statut">
<option>À appeler</option>
<option>RDV</option>
<option>À rappeler</option>
<option>Refus</option>
<option>Hors cible</option>
</select>
<input id="f_rep1" placeholder="Réponse 1">
<input id="f_rep2" placeholder="Réponse 2">
</div>
<textarea id="f_commentaire" placeholder="Commentaire"></textarea>
<div class="row">
<button class="primary" onclick="save()">Enregistrer</button>
<button onclick="closeForm()">Annuler</button>
</div>
</div>

<!-- IMPORT -->
<div id="importCard" class="card hidden">
<b>Import TXT / CSV / XLS avec mapping manuel</b>

<div class="row">
<select id="fmt">
<option value="csv">CSV</option>
<option value="txt">TXT</option>
<option value="xls">XLS / XLSX</option>
</select>

<label class="small">Max</label>
<input id="limitImport" type="number" value="500" min="1" style="width:90px">

<label class="small">TXT sep</label>
<select id="txtSep">
<option value="auto">Auto</option>
<option value="tab">Tab</option>
<option value=";">;</option>
<option value=",">,</option>
<option value="|">|</option>
<option value="space">Espaces</option>
</select>

<label class="small">En-têtes</label>
<select id="txtHasHeader">
<option value="yes">Oui</option>
<option value="no">Non</option>
</select>
</div>

<div class="row">
<input type="file" id="file">
<button onclick="loadFile()">Charger</button>
<span id="importInfo" class="small"></span>
</div>

<div class="map" id="mappingBox"></div>

<div class="row">
<button class="primary" onclick="validateImport()">Valider import</button>
<button onclick="closeImport()">Fermer</button>
</div>

<div class="preview" id="preview">Aperçu…</div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc,
onSnapshot, serverTimestamp, getDocs, query, limit }
from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

/*  FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyA-G8P5NokxI6ZaIOMroQrH4x8mp_Q2dgg",
  authDomain:"axokit-crm-ecoles-e56ab.firebaseapp.com",
  projectId:"axokit-crm-ecoles-e56ab"
});
const db = getFirestore(app);

/*  BASE 2 INDÉPENDANTE */
const COLLECTION = "crm_base2";
const colRef = collection(db, COLLECTION);

const $ = id=>document.getElementById(id);
const clean=v=>(v??"").toString().trim();
const esc=s=>(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;");

let ALL=[], START=0, LIMITN=100, EDIT_ID=null;

$("fb").textContent="Firebase…";
onSnapshot(colRef,s=>{
  ALL=s.docs.map(d=>({id:d.id,...d.data()}));
  $("total").textContent=ALL.length;
  $("fb").textContent="Firebase OK";
  render();
});

function render(){
  const tb=$("tbody");
  const slice=ALL.slice(START,START+LIMITN);
  tb.innerHTML=slice.map(x=>`
<tr>
<td>${esc(x.nom)}</td><td>${esc(x.prenom)}</td>
<td>${esc(x.adresse)}</td><td>${esc(x.ville)}</td>
<td>${esc(x.cp)}</td><td>${esc(x.fixe)}</td>
<td>${esc(x.mobile)}</td><td>${esc(x.rdv)}</td>
<td>${esc(x.rappel)}</td><td>${esc(x.statut)}</td>
<td>${esc(x.rep1)}</td><td>${esc(x.rep2)}</td>
<td>${esc(x.commentaire)}</td>
<td>
<button onclick="editRow('${x.id}')"></button>
<button onclick="delRow('${x.id}')"></button>
</td>
</tr>`).join("")||`<tr><td colspan="14" class="small">Vide</td></tr>`;
}

window.applyRange=()=>{
START=parseInt($("rangeSelect").value);
$("rangeLabel").textContent=(START+1)+"  "+(START+100);
render();
};

window.openForm=()=>{EDIT_ID=null;$("formCard").classList.remove("hidden");};
window.closeForm=()=>{$("formCard").classList.add("hidden");};

window.editRow=id=>{
const x=ALL.find(a=>a.id===id);
EDIT_ID=id;
["nom","prenom","adresse","ville","cp","fixe","mobile","rdv","rappel","rep1","rep2","commentaire"]
.forEach(k=>$("f_"+k).value=x[k]||"");
$("f_statut").value=x.statut||"À appeler";
openForm();
};

window.save=async()=>{
const o={
nom:clean(f_nom.value),prenom:clean(f_prenom.value),
adresse:clean(f_adresse.value),ville:clean(f_ville.value),
cp:clean(f_cp.value),fixe:clean(f_fixe.value),
mobile:clean(f_mobile.value),rdv:clean(f_rdv.value),
rappel:clean(f_rappel.value),statut:f_statut.value,
rep1:clean(f_rep1.value),rep2:clean(f_rep2.value),
commentaire:clean(f_commentaire.value),updatedAt:serverTimestamp()
};
EDIT_ID?await updateDoc(doc(db,COLLECTION,EDIT_ID),o)
:await addDoc(colRef,{...o,createdAt:serverTimestamp()});
closeForm();
};

window.delRow=async id=>{
if(confirm("Supprimer ?")) await deleteDoc(doc(db,COLLECTION,id));
};

window.deleteAll=async()=>{
if(prompt("Mot de passe")!=="admin2026")return;
if(!confirm("SUPPRIMER TOUTE LA BASE 2 ?"))return;
while(true){
const s=await getDocs(query(colRef,limit(500)));
if(s.empty)break;
for(const d of s.docs) await deleteDoc(doc(db,COLLECTION,d.id));
}
};

window.exportCSV=()=>{
let csv="nom;prenom;adresse;ville;cp;fixe;mobile;rdv;rappel;statut;rep1;rep2;commentaire\n";
ALL.forEach(x=>csv+=`${x.nom||""};${x.prenom||""};${x.adresse||""};${x.ville||""};${x.cp||""};${x.fixe||""};${x.mobile||""};${x.rdv||""};${x.rappel||""};${x.statut||""};${x.rep1||""};${x.rep2||""};${x.commentaire||""}\n`);
const a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
a.download="base2.csv";a.click();
};

/* IMPORT = identique Base1 (stable) */
let importHeaders=[],importRows=[];
window.openImport=()=>{$("importCard").classList.remove("hidden");};
window.closeImport=()=>{$("importCard").classList.add("hidden");};
/* Pour import TXT/CSV/XLS  même logique que Base1 */

</script>
</body>
</html>
